#!/bin/bash

tmpl="${GOFILE}.h"
if [ ! -f "$tmpl" ]; then
	echo "ppgo: not found header file ${tmpl}"
	exit 1
fi

base=$(basename $GOFILE .go)
output="${base}_gen.go"
if [[ "$base" =~ "_test" ]]; then
	base=$(basename $base _test)
	output="${base}_gen_test.go"
fi

tmp="${output}.tmp";

vendor="src/github.com/gobwas/ppgo/include"
include=""
for path in ${GOPATH//:/ }; do
	include="$include -I${path}/${vendor}"
done

echo "THIS FILE WAS AUTOGENERATED.\nDO NOT EDIT!\n" \
	> $tmp

# run preprocessor!
cc $include -E -P $tmpl \
	| sed -E -e 's/>>>/\/\//g' \
	| sed -e $'s/;;/\\\n/g' \
	>> $tmp


gofmt "$tmp" > "$output"
rm -f "$tmp"

echo "ppgo: okay for $GOFILE";
