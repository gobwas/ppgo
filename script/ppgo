#!/bin/bash
base=$(basename $GOFILE .go)

for tmpl in "${base}*.go.h"; do
	name=$(basename $tmpl .go.h)
	output="${name}_gen.go"
	if [[ "$name" =~ "_test" ]]; then
		name=$(basename $name _test)
		output="${name}_gen_test.go"
	fi
	
	tmp="${output}.tmp";
	
	vendor="src/github.com/gobwas/ppgo/include"
	include=""
	for path in ${GOPATH//:/ }; do
		include="$include -I${path}/${vendor}"
	done
	
	echo "// THIS FILE WAS AUTOGENERATED.\n// DO NOT EDIT!\n" \
		> $tmp
	
	# run preprocessor!
	cc $include -E -P $tmpl \
		| sed -E -e 's/>>>/\/\//g' \
		| sed -e $'s/;;/\\\n/g' \
		>> $tmp
	
	
	gofmt "$tmp" > "$output"
	rm -f "$tmp"
	
	echo "ppgo: okay for ${tmpl}";
done
